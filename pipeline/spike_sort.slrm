#!/bin/bash
#SBATCH --nodes=1
#SBATCH --mem=32G
#SBATCH --partition=kempner
#SBATCH --account=kempner_bsabatini_lab 
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=2
#SBATCH --gres=gpu:1
#SBATCH --time=24:00:00
#SBATCH --output=ephys-%N.%x.%j.out
#SBATCH --error=ephys-%N.%x.%j.err
#SBATCH --mail-user shunli@g.harvard.edu

DATA_PATH="/n/netscratch/bsabatini_lab/Lab/shunnnli/spikesorting/aind_input/"
WORK_DIR="/n/netscratch/bsabatini_lab/Lab/shunnnli/spikesorting/work_dir/"
PIPELINE_PATH="pipeline/"
RESULTS_PATH="/n/netscratch/bsabatini_lab/Lab/shunnnli/spikesorting/aind_output_scratch/"
BACKUP_PATH="/n/netscratch/bsabatini_lab/Lab/shunnnli/spikesorting/aind_input/"


CONTAINER_DIR="/n/holylfs06/LABS/kempner_shared/Everyone/workflow/ephys-spike-sorting-2024/containers"

INPUT_DATA_TYPE="spikeglx"

module load Mambaforge/23.11.0-fasrc01
mamba activate /n/holylfs06/LABS/kempner_shared/Everyone/workflow/ephys-spike-sorting-2024/versions/latest/software/nextflow_v22.10.6

/n/holylfs06/LABS/kempner_shared/Everyone/workflow/ephys-spike-sorting-2024/cred/kachery_shared_setup.sh

CONTAINER_DIR=$CONTAINER_DIR DATA_PATH=$DATA_PATH RESULTS_PATH=$RESULTS_PATH nextflow  -C $PIPELINE_PATH/nextflow_slurm.config \
    -log $RESULTS_PATH/nextflow.log \
    run $PIPELINE_PATH/main_slurm.nf\
    -work-dir $WORK_DIR \
    --n_jobs 4 \
    --sorter kilosort4 \
    --runmode full \
    --job_dispatch_args "--input $INPUT_DATA_TYPE" --preprocessing_args "--denoising cmr" \
    # --spikesorting_args "--time_range 0 -300"
  
    
